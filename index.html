<html>
<head>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2.2.1/src/js.cookie.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js" charset="utf-8"></script>
    <script src="pivot.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/plotly_renderers.min.js"></script>
    <link rel="stylesheet" type="text/css" href="pivot.css">

<script>
        $(function() {
            var payload;
            var defaultLayout = {
                rows: ["Covenant", "Soulbind"],
                cols: ["Legendary"],
                rowOrder: "value_z_to_a",
                colOrder: "value_z_to_a",
                rendererName: "Heatmap",
                inclusions: {},
                exclusions: {}
            }

            let rend = $.pivotUtilities.renderers;
            let plot = $.pivotUtilities.plotly_renderers;
            delete rend["Table Barchart"];
            rend["Vertical Bar"] = plot["Bar Chart"];
            rend["Horizontal Bar"] = plot["Horizontal Bar Chart"];
            rend["Line Chart"] = plot["Line Chart"];
            rend["Area Chart"] = plot["Area Chart"];

            function getT15(r) {
                switch(r.tal.charAt(0)) {
                    case '1': return "NB";
                    case '2': return "WOE";
                    case '3': return "FON";
                    default: return "";
                }
            }
            function getT40(r) {
                switch(r.tal.charAt(4)) {
                    case '1': return "SOTF";
                    case '2': return "INC";
                    case '3': return "SL";
                    default: return "";
                }
            }
            function getT45(r) {
                switch(r.tal.charAt(5)) {
                    case '1': return "SD";
                    case '2': return "TM";
                    case '3': return "SF";
                    default: return "";
                }
            }
            function getT50(r) {
                switch(r.tal.charAt(6)) {
                    case '1': return "SOL";
                    case '2': return "FOE";
                    case '3': return "NM";
                    default: return "";
                }
            }

            var defaultOptions = {
                renderers: rend,
                hiddenFromDragDrop: ["dps", "cov", "soul", "cond1", "cond2", "leg", "tal"],
                hiddenFromAggregators: ["cov", "soul", "cond1", "cond2", "leg", "tal"],
                aggregators: {
                    "DPS": function() {
                        return $.pivotUtilities.aggregatorTemplates.max()(["dps"])
                    }
                },
                vals: ["dps"],
                rendererOptions: {
                    heatmap: {
                        colorScaleGenerator: function(val) {
                            let min = Math.min(...val);
                            let max = Math.max(...val);
                            return Plotly.d3.scale.linear()
                                .domain([min, max])
                                .range(["#FFFFFF", "#FF7D0A"])
                        }
                    },
                    table: {
                        mouseenterCallback: function(e, value, filters, pivotData) {
                            let $tar = $(e.target);
                            if ($tar.hasClass("pvtVal")) {
                                let buf = [];
                                pivotData.forEachMatchingRecord(filters, function(r) {
                                    buf.push(r);
                                });
                                buf.sort(function(a, b) {
                                    return b.dps - a.dps;
                                });
                                let str = "<table class=\"tip\">";
                                str += "<tr><td class=\"tip-right\">Covenant:</td><td>" + buf[0].Covenant + "</td></tr>";
                                str += "<tr><td class=\"tip-right\">Legendary:</td><td>" + buf[0].Legendary + "</td></tr>";
                                str += "<tr><td class=\"tip-right\">Talents:</td><td>" + buf[0].Talents + "</td></tr>";
                                str += "<tr><td class=\"tip-right\">Soulbind:</td><td>" + buf[0].Soulbind + "</td></tr>";
                                str += "<tr><td class=\"tip-right\">Conduit1:</td><td>" + buf[0].Conduit1 + "</td></tr>";
                                str += "<tr><td class=\"tip-right\">Conduit2:</td><td>" + buf[0].Conduit2 + "</td></tr>";
                                str += "<tr class=\"tip-dps\"><td class=\"tip-right\">DPS:</td><td>" + buf[0].dps.toFixed(2) + "</td></tr>";
                                str += "</table>"
                                let tmp = $(document.createElement('div')).append(str);

                            }
                        }
                    }
                },
                onRefresh: function(c) {
                    if ($("#pivot").tooltip("instance")) {
                        $("#pivot").tooltip("destroy");
                    }
                    $("#pivot").tooltip({
                        items: ".pvtVal",
                        position: {
                            my: "left center",
                            at: "right+7 center",
                            collision: "none"
                        },
                        content: 'NYI'
                    });
                    $("#pivot").tooltip("disable");
                },
                derivedAttributes: {
                    "Covenant": r => { 
                        let c = r.cov;
                        if (c == "night_fae") {
                            c = "Night Fae";
                        }
                        return c;
                    },
                    "Soulbind": r => { return r.soul; },
                    "Legendary": r => { return r.leg; },
                    "Conduit1": r => { return r.cond1.replaceAll('_', ' '); },
                    "Conduit2": r => { return r.cond2.replaceAll('_', ' '); },
                    "Talents": r => {
                        let str = [];
                        str.push(getT15(r));
                        str.push(getT40(r));
                        str.push(getT45(r));
                        str.push(getT50(r));
                        return str.join('/');
                    },
                    "T15": r => { return getT15(r); },
                    "T40": r => { return getT40(r); },
                    "T45": r => { return getT45(r); },
                    "T50": r => { return getT50(r); }
                },
            }

            function load_json(url) {
                $.getJSON(url, function(json) {
                //$.getJSON("https://raw.githubusercontent.com/balance-simc/Balance-SimC/master/" + url, function(json) {
                    payload = json;

                    $("#pivot").pivotUI(json, $.extend({}, defaultOptions, defaultLayout));
                });
            }

            load_json($("#fightstyle").val());

            $("#fightstyle").change(function() {
                load_json($(this).val());
            });

            $("#save").on("click", function() {
                let config = $("#pivot").data("pivotUIOptions");
                let config_copy = {};

                config_copy["rows"] = config.rows;
                config_copy["cols"] = config.cols;
                config_copy["rowOrder"] = config.rowOrder;
                config_copy["colOrder"] = config.colOrder;
                config_copy["rendererName"] = config.rendererName
                config_copy["inclusions"] = config.inclusions;
                config_copy["exclusions"] = config.exclusions;

                Cookies.set("pivotLayout", JSON.stringify(config_copy));
            });
            $("#load").on("click", function() {
                let config = $("#pivot").data("pivotUIOptions");

                $("#pivot").pivotUI(payload, $.extend(config, JSON.parse(Cookies.get("pivotLayout"))), true);
            });
            $("#clear").on("click", function() {
                Cookies.remove("pivotLayout");
            });
            $("#reset").on("click", function() {
                let config = $("#pivot").data("pivotUIOptions");

                $("#pivot").pivotUI(payload, $.extend(config, defaultLayout), true);
            });

            $("#nav a.load").click(function(event) {
                $("#main").remove();
                $(".frames").width("100%");
                $("#side").height("96vh");
            });
        });
        (async () => {
            const response = await fetch('https://api.github.com/repos/balance-simc/Balance-SimC/contents/');
            const data = await response.json();
            let htmlString = '<ul>';
            for (let file of data) {
                let ext = file.name.split('.').pop();
                if (ext == 'txt') {
                    htmlString += `<li><a class="load" href="${file.name}" target="frame">${file.name}</a></li>`;
                }
            }
            htmlString += '</ul>';
            document.getElementById('dir').innerHTML = htmlString;
            $("#dir").find("a.load").click(function(event) {
                $("#main").remove();
                $(".frames").width("100%");
                $("#side").height("96vh");
            });
        })()
    </script>
</head>
<body>
    <div style="display: flex">
        <div id="nav">
            <div><a href="index.html"><b>Home</b></a></div>
            <div><a class="load" href="md.html?file=faq.txt" target="frame"><b>FAQ</b></a></div>
            <div><a class="load" href="md.html?file=balance.txt" target="frame"><b>Balance&nbsp;APL</b></a></div>
            <div><a href="https://github.com/balance-simc/Balance-SimC/issues/new/choose"><b>Report&nbsp;Issue</b></a></div>
            <div><a class="load" href="by_talent.html" target="frame"><b>Detailed&nbsp;Sims</b></a></div>
            <div id="dir"></div>
        </div>
        <div id="main">
            <div class="title">Balance Druid Shadowlands DPS Charts
            <select id="fightstyle">
                <option value="combo_h_1.json">Heroic 1 Target</option>
                <option value="combo_h_2.json">Heroic 2 Targets</option>
                <option value="combo_h_3.json">Heroic 3 Targets</option>
                <option value="combo_h_4.json">Heroic 4 Targets</option>
                <option value="combo_h_5.json">Heroic 5 Targets</option>
                <option value="combo_h_1m.json">Heroic 1T Move</option>
                <option value="combo_h_s.json">Heroic 2T Spread</option>
                <option value="combo_h_d.json">Heroic Dungeon</option>
                <option value="combo_1.json">Mythic 1 Target</option>
                <option value="combo_2.json">Mythic 2 Targets</option>
                <option value="combo_3.json">Mythic 3 Targets</option>
                <option value="combo_4.json">Mythic 4 Targets</option>
                <option value="combo_5.json">Mythic 5 Targets</option>
                <option value="combo_1m.json">Mythic 1T Move</option>
                <option value="combo_s.json">Mythic 2T Spread</option>
                <option value="combo_d.json">Mythic Dungeon</option>
            </select>
            </div>
            <div class="buttons">
                <input type="button" value="Reset Layout" id="reset" />
                <input type="button" value="Save Layout" id="save" />
                <input type="button" value="Load Layout" id="load" />
                <input type="button" value="Clear Saved" id="clear" />
            </div>
            <div id="pivot"></div>
        </div>
        <div class="frames">
            <iframe id="side" name="frame" style="flex-grow: 1;"></iframe>
        </div>
    </div>
</body>
</html>
